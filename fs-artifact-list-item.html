<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="audio-item/audio-item.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
An element that renders any artifact in the gallery list format

Example:

    <fs-artifact-list-item></fs-artifact-list-item>

@group Seed Elements
@element fs-artifact-list-item
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="fs-artifact-list-item">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="fs-artifact-list-item.css">
  <template>
    <iron-ajax id="postTitle"
      url="[[ajaxBase]]/artifactmanager/artifacts/[[data.id]]"
      headers='[[authHeaders]]'
      method="POST"
      on-response="_handlePostTitleResponse"
      on-error="_handlePostTitleError"></iron-ajax>
    <div id='container'>
      <div class='col col-1'>
        <div class='list-preview'>
          <template is='dom-if' if="[[_displayThumbnail(data.thumbUrl, data.category)]]" restamp>
            <iron-image id="thumb" sizing="cover" position="center 15%" class="thumbnail preview" src="[[data.thumbUrl]]"></iron-image>
          </template>
          <template is='dom-if' if='{{_isAudio(data.category)}}' restamp>
              <audio-item class="preview" audio-url='[[data.url]]'></audio-item>
          </template>
          <template is='dom-if' if='{{_showStoryIcon(data.category, data.thumbUrl)}}' restamp>
            <i class='story-icon preview'></i>
          </template>
        </div>

        <template is='dom-if' if='[[_hideContributorName(view, showContributed, _titleInputActive)]]'>
          <div class$='[[_calculateTitleClass(_titleError)]]'>
            <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
            <a class="title-text" href$='[[_href]]' on-tap='_titleLinkOverride' hidden='[[_hideTitle(data.title, _titleInputActive)]]' title='[[data.title]]'><strong>[[data.title]]</strong></a>
            <template is='dom-if' if='[[data.editableByCaller]]'>
              <a href$='[[_href]]?focus=title' on-tap="_toggleAddTitleInput" class='add-styles' hidden='[[_hideAddTitle(data.title, _titleInputActive)]]'>
                <i class='add-icon'></i>[[i18n('add_title')]]
              </a>
              <input class="title-input" type="text" maxlength='140' hidden="[[!_titleInputActive]]" on-keydown="_handleEnterExitBlur" on-blur="_handleEnterExitBlur" on-tap="_stopProp" placeholder$="[[i18n('add_title')]]" />
            </template>
          </div>
        </template>

        <!--Contributed By-->
        <template is='dom-if' if='[[!_hideContributorName(view, showContributed, _titleInputActive)]]'>
          <div class$='[[_calculateTitleClass(_titleError)]]'>
            <div class='contributed-title-text'>
              <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
              <a class="title-text" href$='[[_href]]' hidden='[[_hideTitle(data.title, _titleInputActive)]]' on-tap='_titleLinkOverride' title='[[data.title]]'><strong>[[data.title]]</strong></a>
              <template is='dom-if' if='[[data.editableByCaller]]'>
                <a href$='[[_href]]?focus=title' on-tap="_toggleAddTitleInput" class='add-styles' hidden='[[_hideAddTitle(data.title, _titleInputActive)]]' on-tap='_stopProp'>
                  <i class='add-icon'></i>[[i18n('add_title')]]
                </a>
              </template>
            </div>
            <div class="contributor" title='[[_getContributorName(data.*)]]' hidden='[[!_getContributorName(data.*)]]'>
              <span id='contributor-link' on-click='_openContactCard'></span>
            </div>
          </div>
        </div>
        </template>

      </div>

      <template is="dom-if" if="[[data.tombstoned]]">
        <div class='col col-2'>
          <div class="date">
            <div class="badge-wrapper">
              <small class='badge'>[[_getRemainingDaysCount(i18n, data)]]</small>
            </div>
          </div>
        </div>
      </template>

      <template is="dom-if" if="[[!data.tombstoned]]">
        <div class='col col-2' hidden='[[_showMobileMessage(_displayMessage, mobile)]]'>
          <div class='date'>
            <template is='dom-if' if='[[!data.editableByCaller]]'>
              <a href$='[[_href]][[_calcParams(view)]]&focus=date' class='date-text' title='[[_getDate(data.datesPlaces.0)]]' on-tap='_stopProp' hidden='[[!_hideDateElements(data.datesPlaces.0)]]'>
                <span>[[_getDate(data.datesPlaces.0)]]</span>
              </a>
            </template>
            <template is='dom-if' if='[[data.editableByCaller]]'>
              <a href$='[[_href]][[_calcParams(view)]]&focus=date' class='date-text' hidden='[[!_hideDateElements(data.datesPlaces.0)]]' on-tap='_stopPropForStandards' data-standard-type='date'>
                <span>[[_getDate(data.datesPlaces.0)]]</span>
              </a>
              <a href$='[[_href]][[_calcParams(view)]]&focus=date' class='add-styles' hidden='[[_hideDateElements(data.datesPlaces.0)]]' on-tap='_stopPropForStandards' data-standard-type='date'>
                <i class='add-icon' ></i>[[i18n('add_date')]]
              </a>
            </template>
          </div>
          <div class='place'>
            <template is='dom-if' if='[[!data.editableByCaller]]'>
              <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='place-text' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' title='[[_getPlace(data.datesPlaces.0)]]' on-tap='_stopProp'>
                <span> [[_getPlace(data.datesPlaces.0)]]</span>
              </a>
            </template>
            <template is='dom-if' if='[[data.editableByCaller]]'>
              <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='place-text' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopPropForStandards' data-standard-type='place'>
                <span> [[_getPlace(data.datesPlaces.0)]]</span>
              </a>
              <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='add-styles' hidden='[[_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopPropForStandards' data-standard-type='place'>
                <i class='add-icon'></i>[[i18n('add_place')]]
              </a>
            </template>
          </div>
        </div>
        <div class='col col-3' hidden='[[_showMobileMessage(_displayMessage, mobile)]]'>
          <div class='place'>
            <template is='dom-if' if='[[!data.editableByCaller]]'>
              <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='place-text' title='[[_getPlace(data.datesPlaces.0)]]' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
                <span> [[_getPlace(data.datesPlaces.0)]]</span>
              </a>
            </template>
            <template is='dom-if' if='[[data.editableByCaller]]'>
              <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='place-text' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopPropForStandards' data-standard-type='place'>
                <span> [[_getPlace(data.datesPlaces.0)]]</span>
              </a>
              <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='add-styles' hidden='[[_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopPropForStandards' data-standard-type='place'>
                <i class='add-icon'></i>[[i18n('add_place')]]
              </a>
            </template>
          </div>
        </div>
        <div class='col col-4'>
          <div class='comment-note'>
            <a href$='[[_href]][[_calcParams(view)]]' on-tap='_stopProp'>
              <i class='comment-icon' hidden='[[_hideComments(data.commentCount, _displayMessage)]]' title='[[i18n("comments")]]' href$='[[_href]][[_calcParams(view)]]'>[[data.commentCount]]</i>
            </a>
          </div>
          <div class='tag-note'>
            <a href$='[[_href]][[_calcParams(view)]]' on-tap='_stopProp'>
              <i class='not-tagged-icon' hidden='[[_hideTag(data.photoTagCount, _displayMessage)]]' title='[[i18n("not_tagged")]]'></i>
            </a>
          </div>
        </div>
        <!--Messages-->
        <!--Restricted-->
        <template is='dom-if' if='[[showMessages]]'>
          <div class="restricted layout vertical center-justified right-text" hidden="[[!restricted]]" on-tap='_openInfoDialog'>
            <span>
              [[i18n('restricted')]]
              <span class="info-icon" hidden='[[!_showRestrictedIcon]]'></span>
            </span>
          </div>

          <!--Uploading-->
          <div class="screening layout vertical center-justified" hidden="[[!uploading]]">
            [[i18n('uploading')]]
          </div>

          <!-- Upload Failed -->
          <div class="error-text" hidden="[[!uploadFailed]]">
            [[i18n('upload_failed')]]
          </div>

          <!--Processing-->
          <div class="screening layout vertical center-justified right-text" hidden="[[!processing]]">
            [[i18n('processing')]]
          </div>

          <!--Error Processing-->
          <div class="error-text" hidden="[[!processingFailed]]">
            [[i18n('processing_fail')]]
          </div>

          <!--Screening-->
          <div class="screening layout vertical center-justified right-text" hidden="[[!screening]]">
            [[i18n('screening')]]
          </div>
        </template>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'fs-artifact-list-item',
      behaviors: [
        OakAJAXBehavior,
        WCI18n(),
        OakI18nBehavior,
      ],
      properties: {
        data: {
          type: Object,
          value: function() { return {}; },
        },
        /**
         * If set, enables the user to add a title inline.
        */
        inlineAddingEnabled: {
          type: Boolean,
          value: false
        },
        _href: {
          type: String,
          computed: '_computeHref(data.id)'
        },
        view: {
          type: String,
          value: null,
          observer: '_resetInputs'
        },
        owner: {
          type: String,
          value: ''
        },
        mobile: {
          type: Boolean,
          value: false
        },
        selectMode: {
          type: Boolean,
          value: false
        },
        /**
         * A flag to allow the contributor
         * name to be shown
         */
        showContributed: {
          type: Boolean,
          value: false
        },
        /**
         * A flag to allow messages to
         * be shown
         */
        showMessages: {
          type: Boolean,
          value: false
        },
        /**
        * A flag for showing the restricted
        * info dialog
        */
        showRestrictedInfo: {
          type: Boolean,
          value: false
        },
        /**
        * Flag for showing the restricted icon
        */
        _showRestrictedIcon: {
          type: Boolean,
          computed: '_isOwner(showRestrictedInfo, owner, data.contributorCisUserId, restricted)'
        },
        /**
         * A state message is being displayed
         */
        _displayMessage: {
          type: Boolean,
          value: false
        },
        // State Messages
        screening: {
          type: Boolean,
          value: false
        },
        restricted: {
          type: Boolean,
          value: false
        },
        processing: {
          type: Boolean,
          value: false
        },
        processingFailed: {
          type: Boolean,
          value: false
        },
        uploading: {
          type: Boolean,
          value: false
        },
        uploadFailed: {
          type: Boolean,
          value: false
        },
        readOnly: {
          type: Boolean,
          value: false
        },
        /**
         * Notifier for if the add title input is active.
        */
        alertInputActive: {
          computed: '_computeIsActive(_titleInputActive)',
          notify: true
        },
        _titleInputActive: {
          type: Boolean,
          value: false
        },
        _titleError: {
          type: Boolean,
          value: false
        }
      },
      observers: [
        '_displayFourthColumn(mobile, selectMode)',
        '_modifyState(data.*, showMessages)',
        '_updatePreviewListeners(data.category)',
        '_translateContributor(i18n, data.*)'
      ],
      listeners: {
        'container.tap': '_goToArtifact',
      },
      _getRemainingDaysCount: function(i18n, data) {
        if(!i18n || !i18n('remaining_days_count') || !data) return '';
        return i18n('remaining_days_count').replace('{0}', data.daysUntilDelete);
      },
      _triggerHoverEvent: function(e){
        this.fire('list-item-hover', {positionTarget: this.$$('.list-preview'), data: this.data})
      },
      _triggerMouseOut: function(e){
        this.fire('list-item-mouseout');
      },
      _titleLinkOverride: function(e) {
        if (this.data.tombstoned) {
          e.preventDefault();
          return;
        }
        if (this._titleError) {
          e.preventDefault();
          e.stopPropagation();
          this._titleError = false;
          this._toggleAddTitleInput();
        }
      },
      _calculateTitleClass: function(_titleError) {
        return (_titleError) ? 'title error-styling' : 'title';
      },
      _calcParams: function(view) {
        if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
          return "?c="+this.view;
        } else if(parseInt(this.view)) {
          return "?a="+this.view;
        } else {
          return "?a=none";
        }
      },
      _computeIsActive: function(titleInputActive) {
        if (titleInputActive) return true;
      },
      _computeHref: function(id) {
        var origin = window.location.origin;
        var path = (origin === 'http://localhost:5000') ? '' : '/photos';
        return origin + path + '/artifacts/' + id;
      },
      _handleEnterExitBlur: function(e) {
        this._stopProp(e);
        if (e.keyCode == 13 || e.key == "Enter" || e.type == "blur") {
          e.preventDefault();
          if (e.currentTarget.value.length > 0) {
            this._saveTitle(e.currentTarget.value);
            e.currentTarget.value = '';
          } else {
            this._titleInputActive = false;
          }
          this._focusTitle();
        } else if (e.keyCode === 27) {
          // Handle exit key
          e.currentTarget.value = "";
          this.set('data.title', "");
          this._titleInputActive = false;
          this._focusTitle();
        }
      },
      _getPlace: function(datesPlaces) {
        if (!datesPlaces) return;
        return datesPlaces.placeNonStandardizedText
          || datesPlaces.placeLocalizedText
          || datesPlaces.placeNormalizedText;
      },
      _getDate: function(datesPlaces) {
        if (!datesPlaces) return;
        return datesPlaces.dateNonStandardizedText
          || datesPlaces.dateLocalizedText
          || datesPlaces.dateNormalizedText;
      },
      _handlePostTitleResponse: function(e) {
        if (e.detail.status < 400) this.fire('artifact-item-title-updated')
      },
      _handlePostTitleError: function(e) {
        this._titleError = true;
        this.fire('artifact-item-title-update-failed', e.detail.error);
      },
      _hideAddTitle: function(title, titleInputActive) {
        if (title || titleInputActive) return true;
        return false;
      },
      _hideTitle: function (title, titleInputActive) {
        return (!title || titleInputActive);
      },
      _hidePlaceElements: function(datesPlaces) {
        return !!this._getPlace(datesPlaces);
      },
      _hideDateElements: function(datesPlaces) {
        return !!this._getDate(datesPlaces);
      },
      _hideContributorName: function(view, showContributed, titleInputActive) {
        if (!showContributed || titleInputActive) return true;
        return (view != 'my-favorites' && !Number(view))
      },
      _hideComments: function(count, displayMessage) {
        if (displayMessage) return true;
        return count === 0;
      },
      _hideTag: function(count, displayMessage) {
        if (displayMessage) return true;
        return count > 0;
      },
      /*
        * Takes focus away from input, so keyboard closes on mobile devices.
      */
      _focusTitle: function() {
        if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur();
        this.$$('.title-text').focus();
      },
      _goToArtifact: function(e) {
        if (this.selectMode || this.data.tombstoned) return;
        e.preventDefault();
        this._stopProp(e);
        var url = this._href;

        var newTab = false;
        if (e && e.detail && e.detail.sourceEvent) {
          newTab = e.detail.sourceEvent.ctrlKey || e.detail.sourceEvent.metaKey
        }
        if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
          url = url + "?c="+this.view;
        } else if(parseInt(this.view)) {
          url = url + "?a="+this.view;
        }
        if (newTab){
          window.open(url, '_blank').focus();
        } else {
          location = url;
        }
      },
      _is: function(a, b) {
        return a == b;
      },
      _modifyState: function(data, showMessages) {
        if (!showMessages) return;
        // Reset these states
        this.uploading = false;
        this.uploadFailed = false;
        this.processing = false;
        this.processingFailed = false;
        this.screening = false;
        this.restricted = false;
        this._displayMessage = false;
        // If just uploaded without refresh
        // don't check for the state
        if (this.data.recentlyUploaded) return;

        // Check upload state first and if it is not UPLOADED, display either UPLOADING or FAILED message as appropriate
        // Check processing state next.  If not PROCESSED, display appropriate state message
        // Check screening state. If not APPROVED, display RESTRICTED or SCREENING message as appropriate
        if (this.data.uploadState == 'UPLOADING') {
          this.uploading = true;
          this._displayMessage = true;
        } else if(this.data.uploadState == 'FAILED') {
          this.uploadFailed = true;
          this._displayMessage = true;
        } else if (this.data.category !== 'AUDIO' && this.data.imageProcessingState !== 'PROCESSED' && this.data.imageProcessingState !== 'FAILED') {
          this.processing = true;
          this._displayMessage = true;
        } else if (this.data.imageProcessingState === 'FAILED') {
          this.processingFailed = true;
          this._displayMessage = true;
        } else if (this.data.screeningState !== 'APPROVED' && this.data.screeningState !== 'ESCALATE' && this.data.screeningState !== 'RESTRICTED') {
          this.screening = true;
          this._displayMessage = true;
        } else if (this.data.screeningState === 'RESTRICTED') {
          this.restricted = true;
        }
      },
      _showMobileMessage: function(display, mobile) {
        // Hide the date/place parts to make room for error message
        if ((this.processingFailed || this.restricted) && this.showMessages) return true;

        return (display && mobile);
      },
      _isAudio: function(category) {
        return category && category == "AUDIO";
      },
      _showStoryIcon: function(category, thumbUrl){
        if (thumbUrl) return false;
        return category && category == "TEXT";
      },
      _displayThumbnail: function(thumbUrl, category) {
        return thumbUrl;
      },
      _displayFourthColumn: function(mobile, selectMode) {
        if ((!mobile && !selectMode) || this.data.tombstoned) return;
        var commentEl = this.$$('.comment-note');
        var personTagEl = this.$$('.tag-note');
        if (mobile && selectMode && Boolean(commentEl) && Boolean(personTagEl)) {
          commentEl.hidden = true;
          personTagEl.hidden = true;
        } else if ((commentEl.hidden || personTagEl.hidden) && Boolean(commentEl) && Boolean(personTagEl) ) {
          commentEl.hidden = false;
          personTagEl.hidden = false;
        }
      },
      _resetInputs: function() {
        if (this._titleError) this._titleError = false;
        if (this.$$('.title-input')) this.$$('.title-input').value = "";
      },
      _saveTitle: function(titleText) {
        this.$.postTitle.body = {
          title: titleText
        };
        this.$.postTitle.generateRequest();
        this._titleInputActive = false;
        this.set('data.title', titleText);
      },
      _stopProp: function(e) {
        if (!this.selectMode) e.stopPropagation();
      },
      _stopPropForStandards: function(e) {
        if(!e || !e.currentTarget || !e.currentTarget.getAttribute('data-standard-type')) return;
        this._stopProp(e);
        // Firing an event here so that consumemrs can e.preventDefault() if needed
        this.fire('fs-artifact-list-item:standards-link', {
          click: e,
          el: this,
          standardType: e.currentTarget.getAttribute('data-standard-type')
        });
      },
      _toggleAddTitleInput: function(e) {
        if (this.inlineAddingEnabled) {
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          this._titleInputActive = true;
          // Flush dom so nothing takes the focus after the title input is focus.
          Polymer.dom.flush();
          this.$$('.title .title-input').focus();
        }
      },
      _translateContributor: function(i18n, data) {
        if (!this.showContributed || !data || !data.value || !i18n || !i18n('contributed_by_link')) return;
        var name = (data.value.ftUserInfo) ? data.value.ftUserInfo.contactName : data.value.contributorContactName;
        var contributor = this.$$('#contributor-link');
        if (contributor) contributor.innerHTML = i18n('contributed_by_link').replace('{0}', name);
      },
      _updatePreviewListeners: function(category) {
        if (category == "AUDIO") return;
        Polymer.dom.flush();
        if (this.$$('.preview')) {
          this.listen(this.$$('.preview'), 'mouseover', '_triggerHoverEvent');
          this.listen(this.$$('.preview'), 'mouseout', '_triggerMouseOut');
        }
      },
      _openContactCard: function(e) {
        e.stopPropagation();
        this.fire('gallery-close-contact-card',{});
        var contactData = {'event': e, 'cisId': this.data.contributorCisUserId };
        this.fire('gallery-open-contact-card', contactData);
      },
       _openInfoDialog: function(e) {
        e.stopPropagation();
        e.preventDefault();
        if (!this.showRestrictedInfo || this.owner !== this.data.contributorCisUserId) return;
        var data = {};
        data.translations = {};
        data.translations.restrictedInfo = this.i18n('restricted_info');
        data.translations.checkEmail = this.i18n('check_email');
        data.target = this.$$('.info-icon');
        this.fire('open-restricted-info', data);
      },
      _isOwner: function(experiment, user, contributor, restricted) {
        if (!restricted || !experiment) return false;
        return (user === contributor);
      },
      _getContributorName: function(data) {
        if (data && data.value) {
          return (data.value.ftUserInfo) ? data.value.ftUserInfo.contactName : data.value.contributorContactName;
        }
      }
    });
  </script>
</dom-module>
