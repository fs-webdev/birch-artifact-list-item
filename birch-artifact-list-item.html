<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="audio-item/audio-item.html">
<link rel="import" href="../fs-styles/fs-styles.html">

<!--
An element that renders any artifact in the gallery list format

Example:

    <birch-artifact-list-item></birch-artifact-list-item>

@group Seed Elements
@element birch-artifact-list-item
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-artifact-list-item">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-artifact-list-item.css">
  <template>
    <wc-i18n-src locale='[[lang]]' locale-dir='[[localeDir()]]' domain='birch-artifact-list-item'></wc-i18n-src>
    <div id='container'>
      <div class='col col-1'>
        <div class='list-preview'>
          <template is='dom-if' if="[[_displayThumbnail(data.thumbUrl, data.category)]]">
          <iron-image sizing="cover" position="center 15%" class="thumbnail" src="[[data.thumbUrl]]"></iron-image>
          </template>
          <template is='dom-if' if='{{_isAudio(data.category)}}'>
              <audio-item audio-url='[[data.url]]'></audio-item>
          </template>
          <template is='dom-if' if='{{_isStory(data.category)}}'>
            <i class='story-icon'></i>
          </template>
        </div>
        <div class='title'>
          <a class='title-text' href$='[[_href]]' hidden='[[!data.title]]' title='[[data.title]]'><strong>[[data.title]]</strong></a>
          <a hidden="[[!data.editableByCaller]]" href$='[[_href]]?focus=title' class='add-styles' hidden='[[data.title]]' on-tap='_stopProp'>
            <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_title'></wc-i18n>
          </a>
        </div>
      </div>
      <div class='col col-2'>
        <div class='date'>
          <a href$='[[_href]]?focus=date' class='date-text' title='[[data.datesPlaces.0.dateNormalizedText]]' on-tap='_stopProp'>
            <span hidden='[[!data.datesPlaces.0.dateNormalizedText]]'>[[data.datesPlaces.0.dateNormalizedText]]</span>
          </a>
          <a hidden="[[!data.editableByCaller]]" href$='[[_href]]?focus=date' class='add-styles' hidden='[[data.datesPlaces.0.dateNormalizedText]]' on-tap='_stopProp'>
            <i class='add-icon' ></i><wc-i18n key='birch-artifact-list-item.add_date'></wc-i18n>
          </a>
        </div>
        <div class='place'>
          <a href$='[[_href]]?focus=place' class='place-text' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' title='[[_getPlace(data.datesPlaces.0)]]' on-tap='_stopProp'>
            <span><wc-i18n key='birch-artifact-list-item.in'></wc-i18n> [[_getPlace(data.datesPlaces.0)]]</span>
          </a>
          <a hidden="[[!data.editableByCaller]]" href$='[[_href]]?focus=place' class='add-styles' hidden='[[_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
            <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_place'></wc-i18n>
          </a>
        </div>
      </div>
      <div class='col col-3'>
        <div class='place'>
          <a href$='[[_href]]?focus=place' class='place-text' title='[[_getPlace(data.datesPlaces.0)]]' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
            <span><wc-i18n key='birch-artifact-list-item.in'></wc-i18n> [[_getPlace(data.datesPlaces.0)]]</span>
          </a>
          <a hidden="[[!data.editableByCaller]]" href$='[[_href]]?focus=place' class='add-styles' hidden='[[_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
            <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_place'></wc-i18n>
          </a>
        </div>
      </div>
      <div class='col col-4'>
        <div class='comment-note'>
        <a href$='[[_href]]' on-tap='_stopProp'>
          <i class='comment-icon' hidden='[[!data.commentCount]]' href$='[[_href]]'>[[data.commentCount]]</i>
        </a>
        </div>
        <div class='tag-note'>
        <a href$='[[_href]]' on-tap='_stopProp'>  
          <wc-i18n key='birch-artifact-list-item.not_tagged' provider value='{{_notTaggedText}}'></wc-i18n>
          <i class='not-tagged-icon' hidden='[[!_is(data.photoTagCount, 0)]]' title='[[_notTaggedText]]'></i>
        </a>
        </div>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'birch-artifact-list-item',
      behaviors: [
        WCI18nBehavior,
        OakI18nBehavior,
      ],
      properties: {
        data: {
          type: Object,
          value: function() { return {}; },
        },
        _href: {
          type: String,
          computed: '_computeHref(data.id)'
        },
        view: {
          type: String,
          value: null
        },
        owner: {
          type: String,
          value: ''
        },        
        mobile: {
          type: Boolean,
          value: false
        },
        selectMode: {
          type: Boolean,
          value: false
        },
        readOnly: {
          type: Boolean,
          value: false
        }
      },
      observers: [
        '_displayFourthColumn(mobile, selectMode)'
      ],
      listeners: {
        'container.tap': '_goToArtifact'
      },
      _computeHref: function(id) {
        var origin = window.location.origin;
        var path = (origin === 'http://localhost:5000') ? '' : '/photos';
        return origin + path + '/artifacts/' + id;
      },
      _getPlace: function(datesPlaces) {
        if (!datesPlaces) return;
        return datesPlaces.placeNormalizedText ? datesPlaces.placeNormalizedText : datesPlaces.placeOriginalText;
      },
      _hidePlaceElements: function(datesPlaces) {
        if (datesPlaces) return datesPlaces.placeNormalizedText || datesPlaces.placeOriginalText;
        return false;
      },
      _goToArtifact: function(e) {
        if (this.selectMode) return;
        e.preventDefault();
        this._stopProp(e);
        var url = this._href;

        var newTab = false;
        if (e && e.detail && e.detail.sourceEvent) {
          newTab = e.detail.sourceEvent.ctrlKey || e.detail.sourceEvent.metaKey
        } 
        if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
          url = url + "?c="+this.view;
        } else if(parseInt(this.view)) {
          url = url + "?a="+this.view;
        }
        if (newTab){
          window.open(url, '_blank').focus();
        } else {
          location = url;
        }
      },
      _is: function(a, b) {
        return a == b;
      },
      _isAudio: function(category) {
        return category && category == "AUDIO";
      },
      _isStory: function(category){
        return category && category == "TEXT";
      },
      _displayThumbnail: function(thumbUrl, category) {
        return thumbUrl && category !== 'TEXT';
      },
      _displayFourthColumn: function(mobile, selectMode) {
        if (!mobile && !selectMode) return;
        var commentEl = this.$$('.comment-note');
        var personTagEl = this.$$('.tag-note');
        if (mobile && selectMode && Boolean(commentEl) && Boolean(personTagEl)) {
          commentEl.hidden = true;
          personTagEl.hidden = true;
        } else if ((commentEl.hidden || personTagEl.hidden) && Boolean(commentEl) && Boolean(personTagEl) ) {
          commentEl.hidden = false;
          personTagEl.hidden = false;
        }
      },
      _stopProp: function(e) {
        if (!this.selectMode) e.stopPropagation();
      }
    });
  </script>
</dom-module>
