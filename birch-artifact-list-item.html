<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="audio-item/audio-item.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
An element that renders any artifact in the gallery list format

Example:

    <birch-artifact-list-item></birch-artifact-list-item>

@group Seed Elements
@element birch-artifact-list-item
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-artifact-list-item">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-artifact-list-item.css">
  <template>
    <iron-ajax id="postTitle"
      url="[[ajaxBase]]/artifactmanager/artifacts/[[data.id]]"
      headers='[[authHeaders]]'
      method="POST"
      on-response="_handlePostTitleResponse"
      on-error="_handlePostTitleError"></iron-ajax>
    <wc-i18n-src locale='[[lang]]' locale-dir='[[localeDir()]]' domain='birch-artifact-list-item'></wc-i18n-src>
    <div id='container'>
      <div class='col col-1'>
        <div class='list-preview'>
          <template is='dom-if' if="[[_displayThumbnail(data.thumbUrl, data.category)]]">
          <iron-image sizing="cover" position="center 15%" class="thumbnail" src="[[data.thumbUrl]]"></iron-image>
          </template>
          <template is='dom-if' if='{{_isAudio(data.category)}}'>
              <audio-item audio-url='[[data.url]]'></audio-item>
          </template>
          <template is='dom-if' if='{{_isStory(data.category)}}'>
            <i class='story-icon'></i>
          </template>
        </div>

        <template is='dom-if' if='[[_hideContributorName(view, showContributed, _titleInputActive)]]'>
          <div class='title'>
            <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
            <a class$="[[_calculateTitleClass(_titleError)]]" href$='[[_href]]' on-tap='_titleLinkOverride' hidden='[[_hideTitle(data.title, _titleInputActive)]]' title='[[data.title]]'><strong>[[data.title]]</strong></a>
            <template is='dom-if' if='[[data.editableByCaller]]'>
              <a href$='[[_href]]?focus=title' on-tap="_toggleAddTitleInput" class='add-styles' hidden='[[_hideAddTitle(data.title, _titleInputActive)]]'>
                <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_title'></wc-i18n>
              </a>
              <wc-i18n key='birch-artifact-grid-item.add_title' value={{_addTitle}} provider></wc-i18n>
              <input class="title-input" type="text" maxlength='140' hidden="[[!_titleInputActive]]" on-keydown="_handleEnterExitBlur" on-blur="_handleEnterExitBlur" on-tap="_stopProp" placeholder$="[[_addTitle]]" />
            </template>
          </div>
        </template>

        <!--Contributed By-->
        <wc-i18n key='birch-artifact-list-item.contributed_by' provider value='{{_contributedBy}}'></wc-i18n>
        <template is='dom-if' if='[[!_hideContributorName(view, showContributed, _titleInputActive)]]'>
          <div class='title'>
            <div class='contributed-title-text'>
              <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
              <a class$="[[_calculateTitleClass(_titleError)]]" href$='[[_href]]' hidden='[[_hideTitle(data.title, _titleInputActive)]]' on-tap='_titleLinkOverride' title='[[data.title]]'><strong>[[data.title]]</strong></a>  
              <template is='dom-if' if='[[data.editableByCaller]]'>
                <a href$='[[_href]]?focus=title' on-tap="_toggleAddTitleInput" class='add-styles' hidden='[[_hideAddTitle(data.title, _titleInputActive)]]' on-tap='_stopProp'>
                  <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_title'></wc-i18n>
                </a>
              </template>
            </div>
            <div class="contributor" title='[[data.ftUserInfo.contactName]]'>
              <span></span>[[_translateContributor(_contributedBy)]] <span class='contributor-name' on-tap='_openContactCard'>[[data.ftUserInfo.contactName]]</span>
            </div>
          </div>
        </div>
        </template>

      </div>
      <div class='col col-2' hidden='[[_showMobileMessage(_displayMessage, mobile)]]'>
        <div class='date'>
          <a href$='[[_href]][[_calcParams(view)]]&focus=date' class='date-text' title='[[data.datesPlaces.0.dateNormalizedText]]' on-tap='_stopProp' hidden='[[!data.datesPlaces.0.dateNormalizedText]]'>
            <span>[[data.datesPlaces.0.dateNormalizedText]]</span>
          </a>
          <template is='dom-if' if='[[data.editableByCaller]]'>
            <a href$='[[_href]][[_calcParams(view)]]&focus=date' class='add-styles' hidden='[[data.datesPlaces.0.dateNormalizedText]]' on-tap='_stopProp'>
              <i class='add-icon' ></i><wc-i18n key='birch-artifact-list-item.add_date'></wc-i18n>
            </a>
          </template>
        </div>
        <div class='place'>
          <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='place-text' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' title='[[_getPlace(data.datesPlaces.0)]]' on-tap='_stopProp'>
            <span><wc-i18n key='birch-artifact-list-item.in'></wc-i18n> [[_getPlace(data.datesPlaces.0)]]</span>
          </a>
          <template is='dom-if' if='[[data.editableByCaller]]'>
            <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='add-styles' hidden='[[_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
              <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_place'></wc-i18n>
            </a>
          </template>
        </div>
      </div>
      <div class='col col-3' hidden='[[_showMobileMessage(_displayMessage, mobile)]]'>
        <div class='place'>
          <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='place-text' title='[[_getPlace(data.datesPlaces.0)]]' hidden='[[!_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
            <span><wc-i18n key='birch-artifact-list-item.in'></wc-i18n> [[_getPlace(data.datesPlaces.0)]]</span>
          </a>
          <template is='dom-if' if='[[data.editableByCaller]]'>
            <a href$='[[_href]][[_calcParams(view)]]&focus=place' class='add-styles' hidden='[[_hidePlaceElements(data.datesPlaces.0)]]' on-tap='_stopProp'>
              <i class='add-icon'></i><wc-i18n key='birch-artifact-list-item.add_place'></wc-i18n>
            </a>
          </template>
        </div>
      </div>
      <div class='col col-4'>
        <div class='comment-note'>
          <a href$='[[_href]][[_calcParams(view)]]' on-tap='_stopProp'>
            <i class='comment-icon' hidden='[[_hideComments(data.commentCount, _displayMessage)]]' href$='[[_href]][[_calcParams(view)]]'>[[data.commentCount]]</i>
          </a>
        </div>
        <div class='tag-note'>
          <a href$='[[_href]][[_calcParams(view)]]' on-tap='_stopProp'>  
            <wc-i18n key='birch-artifact-list-item.not_tagged' provider value='{{_notTaggedText}}'></wc-i18n>
            <i class='not-tagged-icon' hidden='[[_hideTag(data.photoTagCount, _displayMessage)]]' title='[[_notTaggedText]]'></i>
          </a>
        </div>
      </div>
      <!--Messages-->
      <!--Restricted-->
      <template is='dom-if' if='[[showMessages]]'>
        <div class="restricted layout vertical center-justified" hidden="[[!restricted]]">
              <wc-i18n class='fs-h5' key='birch-artifact-list-item.restricted'></wc-i18n>
        </div>

        <!--Uploading-->
        <div class="screening layout vertical center-justified" hidden="[[!uploading]]">
            <wc-i18n class='fs-h5' key='birch-artifact-list-item.uploading'></wc-i18n>
        </div>

        <!--Processing-->
        <div class="screening layout vertical center-justified" hidden="[[!processing]]">
            <wc-i18n class='fs-h5' key='birch-artifact-list-item.processing'></wc-i18n>
        </div>

        <!--Error Processing-->
          <div class="error-text" hidden="[[!processingFailed]]">
              <wc-i18n key='birch-artifact-list-item.processing_fail'></wc-i18n>
          </div>

        <!--Screening-->
        <div class="screening layout vertical center-justified" hidden="[[!screening]]">
            <wc-i18n class='fs-h5' key='birch-artifact-list-item.screening'></wc-i18n>
        </div>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'birch-artifact-list-item',
      behaviors: [
        OakAJAXBehavior,
        WCI18nBehavior,
        OakI18nBehavior,
      ],
      properties: {
        data: {
          type: Object,
          value: function() { return {}; },
        },
        inlineAddingEnabled: {
          type: Boolean,
          value: false
        },
        _href: {
          type: String,
          computed: '_computeHref(data.id)'
        },
        view: {
          type: String,
          value: null,
          observer: '_resetInputs'
        },
        owner: {
          type: String,
          value: ''
        },        
        mobile: {
          type: Boolean,
          value: false
        },
        selectMode: {
          type: Boolean,
          value: false
        },
        /**
         * A flag to allow the contributor
         * name to be shown
         */
        showContributed: {
          type: Boolean,
          value: false
        },
        /**
         * A flag to allow messages to
         * be shown
         */
        showMessages: {
          type: Boolean,
          value: false
        },
        /**
         * A state message is being displayed
         */
        _displayMessage: {
          type: Boolean,
          value: false
        },
        // State Messages
        screening: {
          type: Boolean,
          value: false
        },
        restricted: {
          type: Boolean,
          value: false
        },
        processing: {
          type: Boolean,
          value: false
        },
        processingFailed: {
          type: Boolean,
          value: false
        },
        uploading: {
          type: Boolean,
          value: false
        },
        readOnly: {
          type: Boolean,
          value: false
        },
        alertInputActive: {
          computed: '_computeIsActive(_titleInputActive)',
          notify: true
        },
        _titleInputActive: {
          type: Boolean,
          value: false
        },
        _titleError: {
          type: Boolean,
          value: false
        }
      },
      observers: [
        '_displayFourthColumn(mobile, selectMode)',
        '_modifyState(data.*, showMessages)'
      ],
      listeners: {
        'container.tap': '_goToArtifact'
      },
      _titleLinkOverride: function(e) {
        if (this._titleError) {
          e.preventDefault();
          e.stopPropagation();
          this._titleError = false;
          this._toggleAddTitleInput();
        }
      },
      _calculateTitleClass: function(_titleError) {
        return (_titleError) ? 'title-text error-styling' : 'title-text';
      },
      _calcParams: function(view) {
        if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
          return "?c="+this.view;
        } else if(parseInt(this.view)) {
          return "?a="+this.view;
        } else {
          return "?a=none";
        }
      },
      _computeIsActive: function(titleInputActive) {
        if (titleInputActive) return true;
      },
      _computeHref: function(id) {
        var origin = window.location.origin;
        var path = (origin === 'http://localhost:5000') ? '' : '/photos';
        return origin + path + '/artifacts/' + id;
      },
      _handleEnterExitBlur: function(e) {
        this._stopProp(e);
        if ((e.keyCode == 13 || e.key == "Enter" || e.type == "blur") && e.currentTarget.value.length > 0) {
          this._saveTitle(e.currentTarget.value);
          this._focusTitle();
        } else if ((e.keyCode == 13 || e.key == "Enter" || e.type == "blur") && e.currentTarget.value.length == 0) { 
          this._titleInputActive = false;
          this._focusTitle();
        } else if (e.keyCode === 27) {
          // Handle exit key
          e.currentTarget.value = "";
          this.set('data.title', "");
          this._titleInputActive = false;
          this._focusTitle();
        }
      },
      _getPlace: function(datesPlaces) {
        if (!datesPlaces) return;
        return datesPlaces.placeNormalizedText ? datesPlaces.placeNormalizedText : datesPlaces.placeOriginalText;
      },
      _handlePostTitleResponse: function(e) {
        if (e.detail.status < 400) this.fire('artifact-item-title-updated')
      },
      _handlePostTitleError: function(e) {
        this._titleError = true;
        this.fire('artifact-item-title-update-failed', e.detail.error);
      },
      _hideAddTitle: function(title, titleInputActive) {
        if (title || titleInputActive) return true;
        return false;
      },
      _hideTitle: function (title, titleInputActive) {
        return (!title || titleInputActive);
      },
      _hidePlaceElements: function(datesPlaces) {
        if (datesPlaces) return datesPlaces.placeNormalizedText || datesPlaces.placeOriginalText;
        return false;
      },
      _hideContributorName: function(view, showContributed, titleInputActive) {
        if (!showContributed || titleInputActive) return true;
        return (view != 'my-favorites' && !Number(view))
      },
      _hideComments: function(count, displayMessage) {
        if (displayMessage) return true;
        return count === 0;
      },
      _hideTag: function(count, displayMessage) {
        if (displayMessage) return true;
        return count > 0;
      },
      /* 
        * Takes focus away from input, so keyboard closes on mobile devices.
      */
      _focusTitle: function() {
        document.activeElement.blur();
        this.$$('.title-text').focus();
      },
      _goToArtifact: function(e) {
        if (this.selectMode) return;
        e.preventDefault();
        this._stopProp(e);
        var url = this._href;

        var newTab = false;
        if (e && e.detail && e.detail.sourceEvent) {
          newTab = e.detail.sourceEvent.ctrlKey || e.detail.sourceEvent.metaKey
        } 
        if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
          url = url + "?c="+this.view;
        } else if(parseInt(this.view)) {
          url = url + "?a="+this.view;
        }
        if (newTab){
          window.open(url, '_blank').focus();
        } else {
          location = url;
        }
      },
      _is: function(a, b) {
        return a == b;
      },
      _modifyState: function(data, showMessages) {
        if (!showMessages) return;
        // Reset these states
        this.uploading = false;
        this.processing = false;
        this.processingFailed = false;
        this.screening = false;
        this.restricted = false;
        this._displayMessage = false;
        // If just uploaded without refresh
        // don't check for the state
        if (this.data.recentlyUploaded) return;

        // Check upload state first and if it is not UPLOADED, display either UPLOADING or FAILED message as appropriate
        // Check processing state next.  If not PROCESSED, display appropriate state message
        // Check screening state. If not APPROVED, display RESTRICTED or SCREENING message as appropriate
        if (this.data.uploadState == 'UPLOADING') {
          this.uploading = true;
        } else if (this.data.category !== 'AUDIO' && this.data.imageProcessingState !== 'PROCESSED' && this.data.imageProcessingState !== 'FAILED') {
          this.processing = true;
        } else if (this.data.imageProcessingState === 'FAILED') {
          this.processingFailed = true;
        } else if (this.data.screeningState !== 'APPROVED' && this.data.screeningState !== 'ESCALATE' && this.data.screeningState !== 'RESTRICTED') {
          this.screening = true;
        } else if (this.data.screeningState === 'RESTRICTED') {
          this.restricted = true;
        }

        if (this.uploading || this.processing || this.screening || this.processingFailed) this._displayMessage = true;
      },
      _showMobileMessage: function(display, mobile) {
        // Hide the date/place parts to make room for error message
        if (this.processingFailed && this.showMessages) return true;

        return (display && mobile);
      },
      _isAudio: function(category) {
        return category && category == "AUDIO";
      },
      _isStory: function(category){
        return category && category == "TEXT";
      },
      _displayThumbnail: function(thumbUrl, category) {
        return thumbUrl && category !== 'TEXT';
      },
      _displayFourthColumn: function(mobile, selectMode) {
        if (!mobile && !selectMode) return;
        var commentEl = this.$$('.comment-note');
        var personTagEl = this.$$('.tag-note');
        if (mobile && selectMode && Boolean(commentEl) && Boolean(personTagEl)) {
          commentEl.hidden = true;
          personTagEl.hidden = true;
        } else if ((commentEl.hidden || personTagEl.hidden) && Boolean(commentEl) && Boolean(personTagEl) ) {
          commentEl.hidden = false;
          personTagEl.hidden = false;
        }
      },
      _resetInputs: function() {
        if (this._titleError) this._titleError = false;
        if (this.$$('.title-input')) this.$$('.title-input').value = "";
      },
      _saveTitle: function(titleText) {
        this.$.postTitle.body = {
          title: titleText
        };
        this.$.postTitle.generateRequest();
        this._titleInputActive = false;
        this.set('data.title', titleText);
      },
      _stopProp: function(e) {
        if (!this.selectMode) e.stopPropagation();
      },
      _toggleAddTitleInput: function(e) {
        if (this.inlineAddingEnabled) {
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          this._titleInputActive = true;
          // Flush dom so nothing takes the focus after the title input is focus.
          Polymer.dom.flush();
          this.$$('.title .title-input').focus();
        }
      },
      _translateContributor: function(val) {
        return (val) ? val.replace('{0}', '') : '';
      },
      _openContactCard: function(e) {
        e.stopPropagation();
        this.fire('gallery-close-contact-card',{});
        var contactData = {'event': e, 'data': this.data.ftUserInfo }
        this.fire('gallery-open-contact-card', contactData);
      }
    });
  </script>
</dom-module>
